<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ddos on Simba 的喵窩</title><link>https://blog.simbafs.cc/tags/ddos/</link><description>Recent content in Ddos on Simba 的喵窩</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Thu, 13 Feb 2020 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.simbafs.cc/tags/ddos/index.xml" rel="self" type="application/rss+xml"/><item><title>ddos</title><link>https://blog.simbafs.cc/p/ddos/</link><pubDate>Thu, 13 Feb 2020 00:00:00 +0000</pubDate><guid>https://blog.simbafs.cc/p/ddos/</guid><description>&lt;img src="https://blog.simbafs.cc/og/linux/server/ddos.png" alt="Featured image of post ddos" />&lt;h1 id="ddos">&lt;a href="#ddos" class="header-anchor">&lt;/a>DDOS
&lt;/h1>&lt;h2 id="伺服器被-ddos-惹">&lt;a href="#%e4%bc%ba%e6%9c%8d%e5%99%a8%e8%a2%ab-ddos-%e6%83%b9" class="header-anchor">&lt;/a>伺服器被 DDoS 惹
&lt;/h2>&lt;p>今天早上把社團的 reverse proxy server 換成 nginx&lt;br>
下午心血來潮看看 log 檔
因為沒有寫好的工具&lt;br>
首先把 log 檔 cp 到我的電腦再來處理&lt;/p>
&lt;hr>
&lt;p>先寫了一個 script 來計算重複的行數&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># count.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">declare&lt;/span> -A cnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="nb">read&lt;/span> id extre
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> cnt&lt;span class="o">[&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="o">]&lt;/span>++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> id in &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="p">!cnt[@]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">cnt&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;p>再來用 &lt;code>awk&lt;/code> 把 &lt;code>status code&lt;/code> 是 404 的 ip 挑出來
然後丟給 &lt;code>count.sh&lt;/code> 計算每個 ip 有幾個 404
最後再存到 &lt;code>404-ip.txt&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">awk &lt;span class="s1">&amp;#39;$9 == 404 {print $1}&amp;#39;&lt;/span> access.log &lt;span class="p">|&lt;/span> ./count.sh &amp;gt; 404-ip.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;p>再來用 &lt;code>sort&lt;/code> 來排序剛剛的 &lt;code>404-ip.txt&lt;/code>，存到 &lt;code>404-ip-sorted.txt&lt;/code>
&lt;code>sort&lt;/code> 加上 &lt;code>-n&lt;/code> 選項讓他以數字順數排序，預設是以 ascii 順序排序
&lt;code>-r&lt;/code> 讓他由大到小
&lt;code>-k2&lt;/code> 指定以第二欄排序，預設以空白分開，可以用 &lt;code>-t&lt;/code> 改變分隔符號&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sort -n 404-ip.txt -k2 -r &amp;gt; 404-ip-sorted.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;p>這時候來看看 &lt;code>404-ip-sorted.txt&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ head 404-ip-sorted.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">91.199.118.175 1329180
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">91.199.118.212 259477
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">163.172.12.108 145050
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">195.154.161.234 142920
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">195.154.102.22 142450
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">195.154.102.191 137800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">163.172.12.148 132650
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">62.210.220.48 129248
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">195.154.102.159 11353
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">62.210.85.48 11206
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>哇賽！第一名的 ip 送了一百三十多萬個請求&lt;br>
這份 log 檔是在早上十點多才開始紀錄的&lt;br>
平均每秒 41 個請求
這麼多鐵定是 ddos
我們來看看完整的檔案看看有多少人在 DDoS 我們的 server
嗯，總共十九個破千的&lt;br>
這些通通有問題（其實應該以平均請求數來看，但太複雜了所以以後再補
接下來就接把這幾個 ip ban 掉&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo su
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /etc/nginx/sites-enabled/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vi banned-ip.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>將 ip 貼到文件裡面
在一般模式下執行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[esc] :%s/^/deny /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[esc] :%s/&amp;amp;/;/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> ../sites-enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ln -s ../sites-available
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>$ nginx -t&lt;/code> 確認設定檔沒問題
&lt;code>$ systemctl restart nginx&lt;/code> 來重啟伺服器
然後就大公告成了～～
明天再來看看有沒有問題&lt;/p></description></item></channel></rss>